<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crane Scene Viewer</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root {
      --bg-0: #0f1216;
      --bg-1: #1b222b;
      --line: #2f3945;
      --text: #e7edf5;
      --muted: #a6b2c0;
      --accent: #69b4ff;
    }
    html, body {
      margin: 0;
      height: 100%;
      background:
        radial-gradient(1200px 700px at 15% 10%, #25384f 0%, transparent 55%),
        radial-gradient(1000px 600px at 85% 90%, #1f2b39 0%, transparent 50%),
        linear-gradient(150deg, var(--bg-0), var(--bg-1));
      color: var(--text);
      font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
    }
    .shell {
      height: 100%;
      display: grid;
      grid-template-rows: auto 1fr;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(4px);
      background: rgba(15, 18, 22, 0.55);
    }
    .title {
      font-size: 14px;
      letter-spacing: 0.02em;
    }
    .meta {
      font-size: 12px;
      color: var(--muted);
    }
    model-viewer {
      width: 100%;
      height: 100%;
      --poster-color: transparent;
      background: transparent;
    }
    .loading {
      position: fixed;
      left: 12px;
      bottom: 12px;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(15, 18, 22, 0.66);
      z-index: 10;
    }
    .debug-panel {
      position: fixed;
      left: 12px;
      top: 56px;
      width: min(520px, calc(100vw - 24px));
      max-height: min(50vh, 360px);
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(10, 14, 20, 0.9);
      backdrop-filter: blur(4px);
      font-family: "IBM Plex Mono", "SFMono-Regular", Menlo, monospace;
      font-size: 11px;
      line-height: 1.45;
      z-index: 20;
      display: none;
    }
    .debug-panel.open {
      display: block;
    }
    .debug-head {
      position: sticky;
      top: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border-bottom: 1px solid var(--line);
      background: rgba(10, 14, 20, 0.98);
      padding: 8px 10px;
    }
    .debug-title {
      font-size: 11px;
      color: var(--text);
    }
    .debug-actions {
      display: flex;
      gap: 6px;
    }
    .debug-actions button {
      flex: 0 0 auto;
      font-size: 11px;
      padding: 4px 8px;
    }
    .debug-lines {
      margin: 0;
      padding: 8px 10px 10px 10px;
      white-space: pre-wrap;
      word-break: break-word;
      color: #c5d1df;
    }
    .debug-line.error { color: #ff9da6; }
    .debug-line.warn { color: #f7d38c; }
    .debug-line.info { color: #9fc7ff; }
    .controls {
      position: fixed;
      top: 56px;
      right: 12px;
      width: min(320px, calc(100vw - 24px));
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(15, 18, 22, 0.82);
      backdrop-filter: blur(4px);
      padding: 12px;
      z-index: 10;
    }
    .controls h3 {
      margin: 0 0 8px 0;
      font-size: 13px;
      letter-spacing: 0.02em;
      color: var(--text);
    }
    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }
    .row label {
      font-size: 12px;
      color: var(--muted);
    }
    .row input[type="number"] {
      width: 76px;
      background: #11161c;
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 12px;
    }
    .row input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }
    .value {
      min-width: 52px;
      text-align: right;
      font-size: 12px;
      color: var(--text);
    }
    .btns {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
    button {
      flex: 1;
      border: 1px solid var(--line);
      background: #121922;
      color: var(--text);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    button:hover {
      border-color: #4a5b70;
    }
    .hint {
      position: fixed;
      right: 12px;
      bottom: 12px;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(15, 18, 22, 0.66);
    }
    .hint b {
      color: var(--accent);
      font-weight: 600;
    }
    .debug-toggle-row {
      margin-top: 8px;
    }
    .debug-toggle-row button {
      width: 100%;
    }
    .cam-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-top: 8px;
    }
    .cam-row button {
      padding: 6px 8px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <div class="title">Crane Build Sequence</div>
      <div class="meta">GLB • animation enabled • orbit camera</div>
    </header>
    <model-viewer
      src="./crane_scene_web.glb"
      alt="Crane assembly sequence"
      camera-controls
      camera-target="-40m 5m 62m"
      camera-orbit="38deg 68deg 170m"
      min-camera-orbit="auto auto 8m"
      max-camera-orbit="auto auto 450m"
      animation-name="*"
      exposure="1"
      shadow-intensity="0.8"
      environment-image="neutral"
      interaction-prompt="auto">
    </model-viewer>
  </div>
  <aside class="controls">
    <h3>Build Controls</h3>
    <div class="row">
      <label for="heightMeters">Final Height (m)</label>
      <input id="heightMeters" type="number" min="0" max="9" step="0.1" value="9">
    </div>
    <div class="row">
      <input id="heightRange" type="range" min="0" max="9" step="0.1" value="9">
      <div class="value" id="heightValue">9.0m</div>
    </div>
    <div class="row">
      <label for="speedRange">Build Speed</label>
      <div class="value" id="speedValue">1.00x</div>
    </div>
    <div class="row">
      <input id="speedRange" type="range" min="0.1" max="3" step="0.05" value="1">
      <div></div>
    </div>
    <div class="btns">
      <button id="playBtn" type="button">Play to Height</button>
      <button id="resetBtn" type="button">Reset</button>
    </div>
    <div class="cam-row">
      <button id="focusOverviewBtn" type="button">Overview</button>
      <button id="focusTruckBtn" type="button">Truck</button>
      <button id="focusModulesBtn" type="button">Modules</button>
    </div>
    <div class="debug-toggle-row">
      <button id="debugToggleBtn" type="button">Show Debug</button>
    </div>
  </aside>
  <section class="debug-panel" id="debugPanel">
    <div class="debug-head">
      <div class="debug-title">Runtime Debug</div>
      <div class="debug-actions">
        <button id="debugCopyBtn" type="button">Copy</button>
        <button id="debugClearBtn" type="button">Clear</button>
      </div>
    </div>
    <pre class="debug-lines" id="debugLines"></pre>
  </section>
  <div class="loading" id="loadingState">Loading 3D model...</div>
  <div class="hint"><b>Tip:</b> drag to orbit, scroll to zoom</div>
  <script>
    const viewer = document.querySelector("model-viewer");
    const heightMetersInput = document.getElementById("heightMeters");
    const heightRange = document.getElementById("heightRange");
    const heightValue = document.getElementById("heightValue");
    const speedRange = document.getElementById("speedRange");
    const speedValue = document.getElementById("speedValue");
    const playBtn = document.getElementById("playBtn");
    const resetBtn = document.getElementById("resetBtn");
    const focusOverviewBtn = document.getElementById("focusOverviewBtn");
    const focusTruckBtn = document.getElementById("focusTruckBtn");
    const focusModulesBtn = document.getElementById("focusModulesBtn");
    const debugToggleBtn = document.getElementById("debugToggleBtn");
    const debugPanel = document.getElementById("debugPanel");
    const debugLines = document.getElementById("debugLines");
    const debugCopyBtn = document.getElementById("debugCopyBtn");
    const debugClearBtn = document.getElementById("debugClearBtn");
    const loadingState = document.getElementById("loadingState");
    const PRIMARY_MODEL_SRC = "./crane_scene_web.glb";
    const FALLBACK_MODEL_SRC = "./crane_scene_web_draco.glb";
    let retriedWithFullModel = false;
    let debugOpen = new URLSearchParams(location.search).get("debug") === "1";
    let debugEntries = [];
    let lastProgressPct = -1;

    const FALLBACK_BUILD_HEIGHT_M = 9.0;
    let maxBuildHeightM = FALLBACK_BUILD_HEIGHT_M;
    let targetTime = 0;
    let raf = null;
    const CAMERA_PRESETS = {
      overview: { target: "-40m 5m 62m", orbit: "38deg 68deg 170m" },
      truck: { target: "0m 2m -2m", orbit: "48deg 70deg 28m" },
      modules: { target: "-76m 7m 127m", orbit: "42deg 70deg 34m" }
    };

    const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
    const hToProgress = (h) => clamp(h / maxBuildHeightM, 0, 1);
    const now = () => new Date().toISOString().slice(11, 23);

    function stringifyData(data) {
      if (data == null) return "";
      if (typeof data === "string") return data;
      try { return JSON.stringify(data); } catch (_) { return String(data); }
    }

    function renderDebug() {
      debugPanel.classList.toggle("open", debugOpen);
      debugToggleBtn.textContent = debugOpen ? "Hide Debug" : "Show Debug";
      if (!debugOpen) return;
      debugLines.innerHTML = debugEntries
        .map((entry) => `<div class="debug-line ${entry.level}">${entry.text}</div>`)
        .join("");
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    function addDebug(level, message, data) {
      const suffix = stringifyData(data);
      const text = `[${now()}] [${level.toUpperCase()}] ${message}${suffix ? ` | ${suffix}` : ""}`;
      debugEntries.push({ level, text });
      if (debugEntries.length > 300) debugEntries = debugEntries.slice(-300);
      renderDebug();
    }

    async function probeAsset(url) {
      try {
        const r = await fetch(url, { method: "HEAD", cache: "no-store" });
        addDebug("info", `probe ${url}`, {
          ok: r.ok,
          status: r.status,
          type: r.headers.get("content-type"),
          len: r.headers.get("content-length")
        });
      } catch (err) {
        addDebug("error", `probe failed ${url}`, err?.message || String(err));
      }
    }

    function setHeightBounds(maxMeters) {
      const m = clamp(Number(maxMeters) || FALLBACK_BUILD_HEIGHT_M, 1, 120);
      maxBuildHeightM = m;
      const maxText = m.toFixed(1);
      heightMetersInput.max = maxText;
      heightRange.max = maxText;
    }

    function applySpeed(speed) {
      const s = clamp(Number(speed) || 1, 0.1, 3);
      if ("timeScale" in viewer) viewer.timeScale = s;
      if ("playbackRate" in viewer) viewer.playbackRate = s;
      speedValue.textContent = `${s.toFixed(2)}x`;
    }

    function syncHeightUI(h) {
      const hh = clamp(Number(h) || 0, 0, maxBuildHeightM);
      heightMetersInput.value = hh.toFixed(1);
      heightRange.value = String(hh);
      heightValue.textContent = `${hh.toFixed(1)}m`;
      const d = Number(viewer.duration) || 0;
      targetTime = d * hToProgress(hh);
    }

    function stopAtTarget() {
      if (raf) cancelAnimationFrame(raf);
      const tick = () => {
        if (!viewer.duration || viewer.paused) return;
        if (viewer.currentTime >= targetTime) {
          viewer.currentTime = targetTime;
          viewer.pause();
          return;
        }
        raf = requestAnimationFrame(tick);
      };
      raf = requestAnimationFrame(tick);
    }

    function resetPlayback() {
      if (raf) cancelAnimationFrame(raf);
      viewer.pause();
      viewer.currentTime = 0;
    }

    function applyCameraPreset(presetName) {
      const p = CAMERA_PRESETS[presetName];
      if (!p) return;
      viewer.cameraTarget = p.target;
      viewer.cameraOrbit = p.orbit;
      addDebug("info", "camera preset", { preset: presetName, ...p });
    }

    debugToggleBtn.addEventListener("click", () => {
      debugOpen = !debugOpen;
      renderDebug();
    });
    debugClearBtn.addEventListener("click", () => {
      debugEntries = [];
      renderDebug();
    });
    debugCopyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(debugEntries.map((x) => x.text).join("\n"));
        addDebug("info", "debug copied");
      } catch (err) {
        addDebug("warn", "clipboard copy failed", err?.message || String(err));
      }
    });
    focusOverviewBtn.addEventListener("click", () => applyCameraPreset("overview"));
    focusTruckBtn.addEventListener("click", () => applyCameraPreset("truck"));
    focusModulesBtn.addEventListener("click", () => applyCameraPreset("modules"));

    window.addEventListener("error", (e) => {
      addDebug("error", "window error", {
        message: e.message,
        source: e.filename,
        line: e.lineno,
        col: e.colno
      });
    });
    window.addEventListener("unhandledrejection", (e) => {
      addDebug("error", "unhandled rejection", e.reason?.message || String(e.reason));
    });

    addDebug("info", "boot", {
      href: location.href,
      ua: navigator.userAgent,
      crossOriginIsolated: window.crossOriginIsolated
    });
    try {
      const c = document.createElement("canvas");
      const gl2 = c.getContext("webgl2");
      const gl1 = c.getContext("webgl");
      addDebug("info", "webgl", { webgl2: !!gl2, webgl1: !!gl1 });
    } catch (err) {
      addDebug("warn", "webgl probe failed", err?.message || String(err));
    }
    probeAsset(PRIMARY_MODEL_SRC);
    probeAsset(FALLBACK_MODEL_SRC);
    renderDebug();

    viewer.addEventListener("load", () => {
      addDebug("info", "model-viewer load", {
        src: viewer.getAttribute("src"),
        duration: Number(viewer.duration) || 0
      });
      loadingState.style.display = "none";
      // Data-driven max height from model dimensions (fallback to 9m).
      let derivedMax = NaN;
      try {
        if (typeof viewer.getDimensions === "function") {
          const dims = viewer.getDimensions();
          if (dims && Number.isFinite(Number(dims.y))) {
            derivedMax = Number(dims.y);
          }
        }
      } catch (_) {}
      if (!Number.isFinite(derivedMax) || derivedMax <= 0) {
        const attrMax = Number(viewer.getAttribute("data-build-height-max"));
        if (Number.isFinite(attrMax) && attrMax > 0) derivedMax = attrMax;
      }
      setHeightBounds(Number.isFinite(derivedMax) && derivedMax > 0 ? derivedMax : FALLBACK_BUILD_HEIGHT_M);
      syncHeightUI(heightMetersInput.value);
      applySpeed(speedRange.value);
      resetPlayback();
      applyCameraPreset("overview");
    });
    viewer.addEventListener("progress", (e) => {
      const p = Number(e?.detail?.totalProgress) || 0;
      if (p >= 1) return;
      const pct = Math.round(p * 100);
      if (pct !== lastProgressPct) {
        lastProgressPct = pct;
        addDebug("info", "model progress", `${pct}%`);
      }
      loadingState.textContent = `Loading 3D model... ${pct}%`;
    });
    viewer.addEventListener("error", (e) => {
      addDebug("error", "model-viewer error", {
        src: viewer.getAttribute("src"),
        detail: stringifyData(e?.detail)
      });
      if (!retriedWithFullModel) {
        retriedWithFullModel = true;
        loadingState.style.display = "block";
        loadingState.textContent = "Primary model failed, retrying fallback model...";
        addDebug("warn", "fallback to full model");
        viewer.src = FALLBACK_MODEL_SRC;
        return;
      }
      loadingState.textContent = "Model failed to load. Refresh and try again.";
    });

    heightMetersInput.addEventListener("input", (e) => syncHeightUI(e.target.value));
    heightRange.addEventListener("input", (e) => syncHeightUI(e.target.value));
    speedRange.addEventListener("input", (e) => applySpeed(e.target.value));

    playBtn.addEventListener("click", () => {
      if (!viewer.duration) return;
      viewer.currentTime = 0;
      viewer.play();
      stopAtTarget();
    });
    resetBtn.addEventListener("click", resetPlayback);
  </script>
</body>
</html>
